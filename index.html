<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RELY Receipt - Thermal Print Ready</title>
    <style>
        /* Thermal printer optimized styles */
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            body {
                margin: 0 !important;
                padding: 0 !important;
                font-family: 'Courier New', monospace !important;
                font-size: 11px !important;
                line-height: 1.1 !important;
                width: 58mm !important;
                background: white !important;
                color: black !important;
            }
            
            .no-print {
                display: none !important;
            }
            
            .receipt {
                width: 100% !important;
                padding: 2mm !important;
                margin: 0 !important;
                box-sizing: border-box !important;
            }
            
            .header, .order-info, .total-section {
                break-inside: avoid !important;
            }
            
            @page {
                margin: 0 !important;
                size: 58mm auto !important;
            }
        }
        
        /* Screen styles */
        body {
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 300px;
        }
        
        .receipt {
            width: 100%;
            font-size: 12px;
            line-height: 1.3;
        }
        
        .header {
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 1px dashed #333;
            padding-bottom: 10px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #ff4500;
            margin-bottom: 5px;
        }
        
        .contact {
            font-size: 11px;
            margin: 2px 0;
        }
        
        .order-info {
            margin: 15px 0;
            border-bottom: 1px dashed #333;
            padding-bottom: 10px;
        }
        
        .location {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 11px;
        }
        
        .order-header {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .order-item {
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px dotted #ccc;
        }
        
        .item-name {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .item-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
        }
        
        .quantity {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 10px;
        }
        
        .price {
            font-weight: bold;
        }
        
        .total-section {
            margin-top: 15px;
            border-top: 2px solid #333;
            padding-top: 10px;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        
        .total-price {
            font-size: 18px;
            font-weight: bold;
            color: #ff4500;
            border-top: 1px solid #333;
            padding-top: 8px;
            margin-top: 8px;
        }
        
        .status {
            background: #4CAF50;
            color: white;
            padding: 8px;
            text-align: center;
            border-radius: 4px;
            margin-top: 10px;
            font-weight: bold;
        }
        
        .print-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .print-btn {
            background: #ff4500;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .print-btn:hover {
            background: #e63e00;
        }
        
        .print-btn.secondary {
            background: #666;
        }
        
        .print-btn.secondary:hover {
            background: #555;
        }
        
        .printer-status {
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            background: #e8f5e8;
            border: 1px solid #4CAF50;
            border-radius: 5px;
            font-size: 11px;
        }
        
        .divider {
            text-align: center;
            margin: 10px 0;
            font-size: 16px;
        }
        
        .raw-commands {
            display: none;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            font-family: monospace;
            font-size: 10px;
            white-space: pre-wrap;
            border: 1px solid #ddd;
        }
        
        .info-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            font-size: 12px;
        }
        
        .info-section h4 {
            margin-top: 0;
            color: #856404;
        }
        
        .info-section ul {
            margin-bottom: 0;
            padding-left: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="receipt" id="receipt-content">
            <!-- Header -->
            <div class="header">
                <div class="logo">RELY</div>
                <div class="contact">üìß info@rely.co.ke</div>
                <div class="contact">üí¨ WhatsApp</div>
                <div class="contact">üìû +254 700 55 00 55</div>
            </div>
            
            <!-- Location and Order Info -->
            <div class="order-info">
                <div class="location">
                    üìç Lodwar
                    <span style="margin-left: auto; font-size: 10px;">KES</span>
                </div>
                <div class="order-header">Orders</div>
            </div>
            
            <!-- Order Item -->
            <div class="order-item">
                <div class="item-name">üèïÔ∏è Cradle Tented Camp, Lodwar</div>
                <div style="font-size: 10px; color: #666; margin-bottom: 5px;">Order</div>
                <div class="item-details">
                    <div>
                        <span style="color: #666;">Regular</span>
                        <br>
                        <span class="quantity">x4</span>
                        <span style="margin-left: 10px;">‚úÖ</span>
                    </div>
                    <div class="price">KES1,000.00</div>
                </div>
            </div>
            
            <!-- Divider -->
            <div class="divider">================================</div>
            
            <!-- Total Section -->
            <div class="total-section">
                <div class="total-row">
                    <span>Sub-total:</span>
                    <span>KES3,560.00</span>
                </div>
                <div class="total-row">
                    <span>Taxes:</span>
                    <span>KES440.00</span>
                </div>
                <div class="total-row total-price">
                    <span>Total Price:</span>
                    <span>KSh4,000.00</span>
                </div>
            </div>
            
            <!-- Status -->
            <div class="status">‚úÖ Paid</div>
            
            <div class="divider" style="margin-top: 15px;">================================</div>
            
            <div style="text-align: center; margin-top: 10px; font-size: 10px;">
                Thank you for using RELY!<br>
                <span id="timestamp"></span>
            </div>
        </div>
        
        <div class="no-print">
            <div class="printer-status" id="printer-status">
                üñ®Ô∏è Ready to print to thermal printer
            </div>
            
            <div class="print-options">
                <button class="print-btn" onclick="printDirect()">üñ®Ô∏è Print Receipt (Direct)</button>
                <button class="print-btn secondary" onclick="printESCPOS()">üìÑ Print with ESC/POS Commands</button>
                <button class="print-btn secondary" onclick="showRawCommands()">üìã Show Raw Commands</button>
                <button class="print-btn secondary" onclick="downloadReceipt()">üíæ Download Receipt</button>
            </div>
            
            <div class="info-section">
                <h4>üìù Thermal Printer Setup:</h4>
                <ul>
                    <li><strong>USB/Serial:</strong> Install printer drivers and set as default printer</li>
                    <li><strong>Network:</strong> Configure IP address in printer settings</li>
                    <li><strong>Bluetooth:</strong> Pair device and install drivers</li>
                    <li><strong>Paper:</strong> Use 58mm thermal paper rolls</li>
                    <li><strong>ESC/POS:</strong> Most thermal printers support ESC/POS commands</li>
                </ul>
            </div>
            
            <div class="raw-commands" id="raw-commands">
                <!-- ESC/POS commands will be generated here -->
            </div>
        </div>
    </div>

    <script>
        // Set current timestamp
        function updateTimestamp() {
            const now = new Date();
            document.getElementById('timestamp').textContent = now.toLocaleString('en-KE', {
                timeZone: 'Africa/Nairobi',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        updateTimestamp();

        // Direct print function optimized for thermal printers
        function printDirect() {
            try {
                updatePrinterStatus('üñ®Ô∏è Sending to printer...', 'info');
                
                // For better thermal printer compatibility
                const printCSS = `
                    <style>
                        @media print {
                            * { margin: 0 !important; padding: 0 !important; }
                            body { 
                                font-family: 'Courier New', monospace !important; 
                                font-size: 10px !important; 
                                line-height: 1.1 !important; 
                                width: 58mm !important; 
                            }
                            @page { margin: 0 !important; size: 58mm auto !important; }
                        }
                    </style>
                `;
                
                // Add print-specific styles temporarily
                const styleElement = document.createElement('style');
                styleElement.innerHTML = printCSS;
                document.head.appendChild(styleElement);
                
                // Trigger print
                window.print();
                
                // Remove temporary styles after printing
                setTimeout(() => {
                    document.head.removeChild(styleElement);
                    updatePrinterStatus('‚úÖ Print command sent', 'success');
                }, 1000);
                
            } catch (error) {
                console.error('Print error:', error);
                updatePrinterStatus('‚ùå Print failed: ' + error.message, 'error');
            }
        }

        // ESC/POS thermal printer function
        function printESCPOS() {
            const commands = generateESCPOSCommands();
            
            // Try to send raw commands to printer (requires special setup)
            if (navigator.serial) {
                printViaSerial(commands);
            } else {
                // Fallback: copy commands to clipboard
                navigator.clipboard.writeText(commands).then(() => {
                    updatePrinterStatus('üìã ESC/POS commands copied to clipboard', 'info');
                    alert('ESC/POS commands copied to clipboard. Use a thermal printer utility to send them.');
                }).catch(() => {
                    showRawCommands();
                });
            }
        }

        // Generate ESC/POS commands for thermal printer
        function generateESCPOSCommands() {
            const ESC = '\x1B';
            const GS = '\x1D';
            
            let commands = '';
            commands += ESC + '@'; // Initialize printer
            commands += ESC + 'a' + '\x01'; // Center align
            commands += GS + '!' + '\x11'; // Double height and width
            commands += 'RELY\n';
            commands += GS + '!' + '\x00'; // Normal size
            commands += 'info@rely.co.ke\n';
            commands += 'WhatsApp\n';
            commands += '+254 700 55 00 55\n';
            commands += '================================\n';
            commands += ESC + 'a' + '\x00'; // Left align
            commands += 'Lodwar - KES\n';
            commands += 'Orders\n\n';
            commands += 'Cradle Tented Camp, Lodwar\n';
            commands += 'Order\n';
            commands += 'Regular x4     KES1,000.00\n';
            commands += '================================\n';
            commands += 'Sub-total:     KES3,560.00\n';
            commands += 'Taxes:           KES440.00\n';
            commands += '================================\n';
            commands += ESC + 'E' + '\x01'; // Bold on
            commands += 'Total Price:   KSh4,000.00\n';
            commands += ESC + 'E' + '\x00'; // Bold off
            commands += '================================\n';
            commands += ESC + 'a' + '\x01'; // Center align
            commands += 'PAID\n';
            commands += '================================\n';
            commands += 'Thank you for using RELY!\n';
            commands += new Date().toLocaleString() + '\n';
            commands += '\n\n\n'; // Paper feed
            commands += GS + 'V' + '\x42' + '\x00'; // Partial cut
            
            return commands;
        }

        // Serial API for direct printer communication (Chrome 89+)
        async function printViaSerial(commands) {
            try {
                updatePrinterStatus('üîå Connecting to serial printer...', 'info');
                
                const port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });
                
                const writer = port.writable.getWriter();
                const encoder = new TextEncoder();
                await writer.write(encoder.encode(commands));
                
                writer.releaseLock();
                await port.close();
                
                updatePrinterStatus('‚úÖ Printed successfully via serial', 'success');
                
            } catch (error) {
                console.error('Serial print error:', error);
                updatePrinterStatus('‚ùå Serial print failed: ' + error.message, 'error');
            }
        }

        // Show raw ESC/POS commands
        function showRawCommands() {
            const commands = generateESCPOSCommands();
            const rawDiv = document.getElementById('raw-commands');
            
            // Convert control characters to visible format
            const visibleCommands = commands
                .replace(/\x1B/g, 'ESC')
                .replace(/\x1D/g, 'GS')
                .replace(/\x00/g, '[NULL]')
                .replace(/\x01/g, '[SOH]')
                .replace(/\x11/g, '[DC1]')
                .replace(/\x42/g, '[B]');
            
            rawDiv.textContent = visibleCommands;
            rawDiv.style.display = rawDiv.style.display === 'block' ? 'none' : 'block';
        }

        // Download receipt as text file
        function downloadReceipt() {
            const receiptText = `
RELY
info@rely.co.ke
WhatsApp
+254 700 55 00 55

================================
Lodwar - KES
Orders

Cradle Tented Camp, Lodwar
Order
Regular x4               KES1,000.00
================================
Sub-total:               KES3,560.00
Taxes:                     KES440.00
================================
Total Price:             KSh4,000.00
================================
PAID
================================
Thank you for using RELY!
${new Date().toLocaleString()}
            `;
            
            const blob = new Blob([receiptText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'RELY_Receipt_' + Date.now() + '.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            updatePrinterStatus('üíæ Receipt downloaded', 'success');
        }

        // Update printer status display
        function updatePrinterStatus(message, type) {
            const statusDiv = document.getElementById('printer-status');
            statusDiv.textContent = message;
            
            // Update styling based on type
            statusDiv.className = 'printer-status';
            if (type === 'error') {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.borderColor = '#f5c6cb';
                statusDiv.style.color = '#721c24';
            } else if (type === 'success') {
                statusDiv.style.background = '#d4edda';
                statusDiv.style.borderColor = '#c3e6cb';
                statusDiv.style.color = '#155724';
            } else {
                statusDiv.style.background = '#cce7ff';
                statusDiv.style.borderColor = '#99d3ff';
                statusDiv.style.color = '#004085';
            }
            
            // Reset to default after 3 seconds
            setTimeout(() => {
                statusDiv.textContent = 'üñ®Ô∏è Ready to print to thermal printer';
                statusDiv.className = 'printer-status';
                statusDiv.style.background = '#e8f5e8';
                statusDiv.style.borderColor = '#4CAF50';
                statusDiv.style.color = 'inherit';
            }, 3000);
        }

        // Auto-print functionality
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const autoPrint = urlParams.get('autoprint');
            
            if (autoPrint === 'true') {
                setTimeout(printDirect, 1000);
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                printDirect();
            }
        });
    </script>
</body>
</html>